@inject LanguageService language

<div class="tab-pane fade show active" id="tab1" role="tabpanel" aria-labelledby="list-home-list">
	<div class="card custom-card">


		<div class="card-header d-flex justify-content-between">

			<h3 class="card-title">@language.Getkey("Title_Queries")</h3>

			<div class="d-flex  justify-content-between">
				<div class="main-header-center ms-3 d-none d-lg-block form-group">
					<input class="form-control" placeholder="Busca por el nombre de articulo" name="nomart" id="nomart"> 
					<button class="btn" style="top: 12px;right: 60px;" type="submit">
						<i class="fa fa-search" id="btn_apply_search" style=" color: #b4bdce!important;" aria-hidden="true"></i>
					</button>
				</div>
				<i class="fa fa-filter open-filter" style="font-size: 30px;padding-left: 15px;padding-top: 3px; cursor:pointer"></i>
			</div>
		</div>
		<div class="card-body filter-option" style="display:none;">
			<div>
				<p class="text-muted card-sub-title"></p>
			</div>

			<div class="row">

				<div class="col-xs-12 col-sm-12 col-md-6 col-lg-6 col-xl-4 form-group">
					<label class="form-label">Codigo Clase</label>
					<input id="codcla" name="codcla" type="text" class="form-control" placeholder="Inserte Codigo" aria-label="" aria-describedby="Label_Codcla">
				</div>

				<div class="col-xs-12 col-sm-12 col-md-6 col-lg-6 col-xl-4 form-group">
					<label class="form-label">Codigo Grupo</label>
					<input id="codgru" name="codgru" type="text" class="form-control" placeholder="Inserte Codigo" aria-label="" aria-describedby="Label_Codgru">
				</div>
					 
				<div class="col-xs-12 col-sm-12 col-md-6 col-lg-6 col-xl-4 form-group">
					<label class="form-label">Almacen</label>
					<select name="codalm" id="codalm" class="form-control form-select select2" style="width: 100%">
						<option value="" selected>Selecciona una opción...</option>
						<option value="A1">Centro de Acopio</option>
						<option value="B1">Orellana</option>
						<option value="C1">Jardin</option>
						<option value="C2">Cuenca</option>
						<option value="E1">Quicentro</option>
						<option value="G1">CCI</option>
						<option value="H1">Bosque</option>
						<option value="I1">Cumbaya</option>
					</select>
				</div>


			</div>
				

			<div class="row mt-5">


				<div class="col-xs-12 col-sm-12 col-md-6 col-lg-6 col-xl-4 form-group">
					<label class="form-label">Codigo Familia</label>
					<input id="codfam" name="codfam" type="text" class="form-control" placeholder="Inserte Codigo" aria-label="" aria-describedby="Label_Codfam">
				</div>

				<div class="col-xs-12 col-sm-12 col-md-6 col-lg-6 col-xl-4 form-group">
					<label class="form-label">Codigo Articulo</label>
					<input id="codart" name="codart" type="text" class="form-control" placeholder="Inserte Codigo" aria-label="" aria-describedby="Label_Codart">
				</div>

				<div class="col-xs-12 col-sm-12 col-md-6 col-lg-6 col-xl-4 form-group">
					<label class="form-label">Codigo de Barras</label>
					<input id="desart" id="desart" type="text" class="form-control" placeholder="Inserte Codigo" aria-label="" aria-describedby="Label_Desart">
				</div>


			</div>

			<div class="form-footer mt-5 d-flex justify-content-end">
				<a id="btn_apply" class="btn btn-pill btn-primary">@language.Getkey("Button_Apply")</a>
			</div>


		</div>
	</div>
	<div class="row" id="showProductTable" style="display:none;">
		<div class="col-12">
			<div class="card custom-card">
				<div class="card-body">
					<div class="table-responsive">
						<table id="table_gerencias1" class="table table-bordered text-nowrap mb-0" style="width: 100%">
							<thead class="border-top">
								<tr>
									<th class="bg-transparent border-bottom-0">@language.Getkey("Table_Header_Code")</th>
									<th class="bg-transparent border-bottom-0">@language.Getkey("Table_Header_Name")</th>
									<th class="bg-transparent border-bottom-0">@language.Getkey("Table_Header_Stock")</th>
									<th class="bg-transparent border-bottom-0">PVP ($)</th>
								</tr>
							</thead>
						</table>
					</div>
				</div>
			</div>

		</div>
		<div class="col-12" id="showSelectedData" style="display:none;">
			<div class="card custom-card">
				<div class="card-body">
					<div class="table-responsive">
						<table id="table_gerencias2" class="table table-bordered text-nowrap mb-0" style="width: 100%"> 
							<thead class="border-top">
								<tr>
									<th class="bg-transparent border-bottom-0">@language.Getkey("Table_Header_Storage")</th>
									<th class="bg-transparent border-bottom-0">@language.Getkey("Table_Header_Stock")</th>
									<th class="bg-transparent border-bottom-0">@language.Getkey("Table_Header_LastPurchases")</th>
									<th class="bg-transparent border-bottom-0">@language.Getkey("Table_Header_LastSale")</th>
								</tr>
							</thead>
						</table>
					</div>
				</div>
			</div>

		</div>
	</div>
	<div class="row" id="additonalData" style="display:none;">
		<div class="col-lg-6 col-md-12">
			<div class="card">
				<div class="card-header">
					<h3 class="card-title">Grafico de Almacenes</h3>
				</div>
				<div class="card-body">
					<h3 class="card-title">Almacén vs Existencias</h3>
					<div id="chart"></div>
				</div>
			</div>
		</div>
		<div class="col-lg-6 col-md-12">
			<div class="card">
				<div class="card-header">
					<h3 class="card-title">@language.Getkey("Title_AdditionalData")</h3>
				</div>
				<div class="card-body">
					<div class="wideget-user">
						<div class="row">
							<div class="col-lg-6 col-md-6 col-xl-6">
								<div class="wideget-user-img" >
									<img id="productImg" src="" alt="img" />
								</div>
							</div>
							<div class="col-lg-6 col-md-6 col-xl-6">
								<div class="wideget-user-desc d-flex justify-content-center">
									
									<div class="user-wrap" id="ProductoInformation">
										

									</div>
								</div>
							</div>
							
						</div>
					</div>
					<div class="border-top">
					</div>

				</div>
			</div>
		</div>
	</div>

</div>


<script>

	var chart;

	$(document).ready(function () {

		//Función que permite el toggle del filtro
		$(".open-filter").click(function () {
			$(".filter-option").toggle("show");
		});

		//Datatable Initialization
		$('#table_gerencia1').DataTable();
		$('#table_gerencia2').DataTable();


		var options = {
			chart: {
				height: 480,
				type: 'bar'
			},
			series: [],
			plotOptions: {
				bar: {
					borderRadius: 4,
					horizontal: true,
				}
			},
			dataLabels: {
				enabled: false
			},
			xaxis: {
				categories: [],
			}
		}

		chart = new ApexCharts(document.querySelector("#chart"), options);
		chart.render();



	});

	//Función llamado ajax para consultar existencias del producto
	function GetDashboard() {
		var codemp = "01";

		var link = "@Html.Raw(@Url.Action("PVT_S_DASHBOARD_EXISTENCIA", "Report", new { codemp = "_codemp", codgru = "_codgru", codalm = "_codalm", codcla = "_codcla", codfam = "_codfam", codart = "_codart", desart = "_desart", nomart = "_nomart"}))";
		link = link.replace("_codemp", codemp);
		link = link.replace("_codgru", $("#codgru").val());
		link = link.replace("_codalm", $("#codalm").val());
		link = link.replace("_codcla", $("#codcla").val());
		link = link.replace("_codfam", $("#codfam").val());
		link = link.replace("_codart", $("#codart").val());
		link = link.replace("_desart", $("#desart").val());
		link = link.replace("_nomart", $("#nomart").val());

		$.ajax({
			url: link,
			type: "GET",
			dataType: "json",
			//data: { codemp: codemp, codgru: types[0], codalm: types[1], codcla: types[2], codfam: types[3], codart: types[4], desart: types[5], nomart: types[6] },
			success: function (data) {
				showProductTable(data);
			},
			error: function (req, status, error) {
				console.log(status);
			}
		});
	}

	//Función llamado ajax para consultar almacen e imagen
	function GetDataReport(codart, exiact) {
		var codemp = "01";
		var link = "@Html.Raw(@Url.Action("dashboard_existencia_alm_img", "Report", new { codemp = "_codemp", codart = "_codart", exiact = "_exiact"}))";
		link = link.replace("_codemp", codemp);
		link = link.replace("_codart", codart);
		link = link.replace("_exiact", exiact);

		$.ajax({
			url: link,
			type: "GET",
			dataType: "json",
			success: function (data) {
				console.log(data);
				showSelectedProductTable(data.pvT_S_DASHBOARD_EXISTENCIA_alm);
				showGraph(data.pvT_S_DASHBOARD_EXISTENCIA_alm);
				showProductIMG(data.pvT_S_DASHBOARD_EXISTENCIA_IMG);
			},
			error: function (req, status, error) {
				console.log(status);
			}
		});
	}
	$(function () {
		$('#btn_apply').click(GetDashboard);
	});
	$(function () {
		$('#btn_apply_search').click(GetDashboard);
	});

	//Función para rellenar DataTable a partir de la consulta de filtros
	function showProductTable(result){
		if($("#showProductTable").is(":hidden")){
			$("#showProductTable").toggle("show");
		}
		var table = $('#table_gerencias1').DataTable({
			destroy: true,
			data: result,
			columns: [
				{ data: 'codart' },
				{ data: 'nomart' },
				{ data: 'exiact' },
				{ data: 'prec01' }
			],
			"pageLength": 10
		});

		//DataTable click row and obtain value
		$('#table_gerencias1 tbody').on('click', 'tr', function () {
			var data = table.row(this).data();
			if ($(this).hasClass('selected')) {
				$(this).removeClass('selected');
			} else {
				table.$('tr.selected').removeClass('selected');
				$(this).addClass('selected');
			}
			GetDataReport(data.codart, data.exiact);
		});
	}

	//Función para rellenar DataTable de solo un Producto
	function showSelectedProductTable(result){
		if($("#showSelectedData").is(":hidden")){
			$("#showSelectedData").toggle("show");
		}

		var table = $('#table_gerencias2').DataTable({
			destroy: true,
			data: result,
			columns: [
				{ data: 'nomalm' },
				{ data: 'exiact' },
				{ data: 'ultcom' },
				{ data: 'ultven' }
			],
			"pageLength": 10
		});
	}

	//Función para cargar valores y mostrar gráfico usando apexchart
	function showGraph(informes) {
		var seriesList = []
		var categoriesList = []
		$.each(informes, function (k, v) {
			seriesList.push(v.exiact);
			categoriesList.push(v.nomalm);
		});
		
		chart.updateOptions({
			xaxis: {
				categories: categoriesList
			}
		});

		chart.updateSeries([{
			data:seriesList
		}]);
	}

	//Funciíon que muestra datos adicionales del producto como: imagen
	function showProductIMG(result) {

		if($("#additonalData").is(":hidden")){
			$("#additonalData").toggle("show");
		}

		imgurl = "/kohinor/images/IMG/" + result[0].codalt.trim() + ".jpg"

		$('img[id$=productImg]').load(imgurl, function (response, status, xhr) {
			if (status == "error")
				$(this).attr('src', '/kohinor/images/image_not_available.png');
			else
				$(this).attr('src', imgurl);
		});
		


		$("#ProductoInformation").html(
		"<h4>" + result[0].nomart +"</h4>" +
		"<h6 class='text-muted mb-3'> Codigo: " + result[0].codart + "</h6>" +
			"<h6 class='text-muted mb-3'> SKU: " + result[0].desart + " </h6>" +
			"<h6 class='text-muted mb-3'> Clase: " + result[0].nomcla + " </h6>" +
			"<h6 class='text-muted mb-3'> Familia: " + result[0].nomfa + " </h6>" +
			"<h6 class='text-muted mb-3'> Modelo: " + result[0].modbasS + " </h6>" +
		"<br/>"+
		"<h5>Datos Tecnicos </h5>"+
			"<h6 class='text-muted mb-3'> Referencia: " + result[0].codalt + " </h6>" +
			"<h6 class='text-muted mb-3'> Galga: " + result[0].galmat + " </h6>" +
			"<h6 class='text-muted mb-3'> Hebras: " + result[0].numheb + " </h6>" +
			"<h6 class='text-muted mb-3'> Materiales: "  + " </h6>"+
			"<h6 class='text-muted mb-3'> Descripción: "  + " </h6>"
		);


	}

</script>
